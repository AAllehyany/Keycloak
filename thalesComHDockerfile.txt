FROM quay.io/keycloak/keycloak:22.0.1 as builder

ARG KC_DB_PASSWORD
ARG KC_DB_URL
ARG KC_DB_USERNAME

ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_DB=postgres
ENV KC_PROXY=edge
ENV KC_DB_PASSWORD=$KC_DB_PASSWORD
ENV KC_DB_URL=$KC_DB_URL
ENV KC_DB_USERNAME=$KC_DB_USERNAME
# Make sure to save the data before the container is stopped
ENV QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY=true

WORKDIR /opt/keycloak

RUN /opt/keycloak/bin/kc.sh build

FROM quay.io/keycloak/keycloak:22.0.1 as runner

ARG KC_DB_PASSWORD
ARG KC_DB_URL
ARG KC_DB_USERNAME

ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_DB=postgres
ENV KC_PROXY=edge
ENV KC_DB_PASSWORD=$KC_DB_PASSWORD
ENV KC_DB_URL=$KC_DB_URL
ENV KC_DB_USERNAME=$KC_DB_USERNAME
# Make sure to save the data before the container is stopped
ENV QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY=true

COPY --from=builder /opt/keycloak/ /opt/keycloak/
# Custom login theme (keywind)
COPY --chown=keycloak:keycloak ./vendors/keywind.jar /opt/keycloak/providers/keywind.jar

ENTRYPOINT ["/opt/keycloak/bin/kc.sh", "start", "--optimized"]